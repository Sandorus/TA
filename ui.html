<!DOCTYPE html>
<html>
<head>
  <title>Race Engineer UI</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; }
    .state { font-size: 24px; margin-bottom: 10px; }
    .listening { color: cyan; }
    .thinking { color: orange; }
    .speaking { color: lime; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #444; padding: 4px; }
  </style>
</head>
<body>

<div id="state" class="state">State: idle</div>
<div><b>STT:</b> <span id="stt"></span></div>
<div><b>Engineer:</b> <span id="engineer"></span></div>
<div><b>Lap:</b> <span id="lap"></span></div>

<h3>Drivers</h3>
<table>
  <thead>
    <tr>
        <th>Pos</th>
        <th>Name</th>
        <th>Lap</th>
        <th>Pits</th>
        <th>Gap to Leader</th>
    </tr>
  </thead>
  <tbody id="drivers"></tbody>
</table>

<script>
const ws = new WebSocket("ws://localhost:8765/ws");

ws.onmessage = (e) => {
  const d = JSON.parse(e.data);

  // --- Update assistant state & text fields ---
  const stateEl = document.getElementById("state");
  if (stateEl) {
      stateEl.textContent = "State: " + (d.assistant_state || "idle");
      stateEl.className = "state " + (d.assistant_state || "idle");
  }

  const sttEl = document.getElementById("stt");
  if (sttEl) sttEl.textContent = d.realtime_stt || "";

  const engineerEl = document.getElementById("engineer");
  if (engineerEl) engineerEl.textContent = d.last_engineer_text || "";

  const lapEl = document.getElementById("lap");
  if (lapEl) lapEl.textContent = (d.current_lap != null ? d.current_lap : 0);

  const fastestLapEl = document.getElementById("fastest-lap");
  if (fastestLapEl) fastestLapEl.textContent = (d.fastest_lap != null ? d.fastest_lap.toFixed(3) : "n/a");

  const pitDeltaEl = document.getElementById("pit-delta");
  if (pitDeltaEl) pitDeltaEl.textContent = (d.pit_delta != null ? d.pit_delta.toFixed(1) : "-");

  // --- Update driver table ---
  const tbody = document.getElementById("drivers");
  if (tbody) {
      tbody.innerHTML = "";

      const driversArray = Object.entries(d.drivers || {})
          .map(([name, info]) => ({ name, ...info }))
          .sort((a, b) => (a.position != null ? a.position : 999) - (b.position != null ? b.position : 999));

      driversArray.forEach(driver => {
          const gap = (driver.gap_to_leader != null ? driver.gap_to_leader.toFixed(2) + "s" : "-");
          tbody.innerHTML += `<tr>
            <td>${driver.position != null ? driver.position : "-"}</td>
            <td>${driver.name}</td>
            <td>${driver.lap != null ? driver.lap : 0}</td>
            <td>${driver.pits != null ? driver.pits : 0}</td>
            <td>${gap}</td>
          </tr>`;
      });
  }
};
</script>




</body>
</html>
